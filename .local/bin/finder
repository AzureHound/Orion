#!/bin/bash

# Script to prevent Finder from becoming focused automatically
# Run this script in the background to monitor and prevent Finder focus

monitor_focus() {
    while true; do
        # Get the current frontmost application
        current_app=$(osascript -e 'tell application "System Events" to get name of first application process whose frontmost is true')
        
        if [ "$current_app" = "Finder" ]; then
            # Get list of visible applications excluding Finder
            visible_apps=$(osascript -e '
                tell application "System Events"
                    set appList to {}
                    repeat with proc in (every application process whose visible is true)
                        if name of proc is not "Finder" then
                            set end of appList to name of proc
                        end if
                    end repeat
                    return appList
                end tell
            ')
            
            # If there are other visible apps, switch to one of them
            if [ ! -z "$visible_apps" ] && [ "$visible_apps" != "" ]; then
                # Get the first non-Finder app and activate it
                target_app=$(echo "$visible_apps" | cut -d',' -f1 | tr -d ' ')
                if [ ! -z "$target_app" ]; then
                    osascript -e "tell application \"$target_app\" to activate" 2>/dev/null
                fi
            else
                # Hide Finder if no other apps are visible
                osascript -e 'tell application "Finder" to set visible to false'
            fi
        fi
        
        sleep 0.5  # Check every half second
    done
}

# Function to run the monitor in background
start_monitor() {
    echo "Starting Finder focus prevention monitor..."
    monitor_focus &
    echo $! > ~/.finder_focus_monitor.pid
    echo "Monitor started with PID: $(cat ~/.finder_focus_monitor.pid)"
}

# Function to stop the monitor
stop_monitor() {
    if [ -f ~/.finder_focus_monitor.pid ]; then
        pid=$(cat ~/.finder_focus_monitor.pid)
        kill $pid 2>/dev/null
        rm ~/.finder_focus_monitor.pid
        echo "Monitor stopped"
    else
        echo "No monitor running"
    fi
}

# Handle command line arguments
case "$1" in
    start)
        start_monitor
        ;;
    stop)
        stop_monitor
        ;;
    restart)
        stop_monitor
        start_monitor
        ;;
    *)
        echo "Usage: $0 {start|stop|restart}"
        echo "  start   - Start the Finder focus prevention monitor"
        echo "  stop    - Stop the monitor"
        echo "  restart - Restart the monitor"
        exit 1
        ;;
esac
